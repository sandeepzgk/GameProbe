<!DOCTYPE html>
<html lang="en" class="">
    <head>
        <meta charset="UTF-8" />
        
        
        <script src="https://accounts.google.com/gsi/client" async defer></script>
        <script src="https://cdn.jsdelivr.net/npm/jwt-decode@2.2.0/build/jwt-decode.min.js"></script>
        
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" />
        <script src="//cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.production.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/react-dom/17.0.2/umd/react-dom.production.min.js"></script>
        <script src="//unpkg.com/@rjsf/core/dist/react-jsonschema-form.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <link rel="stylesheet" href="assets/corestyle.css" />
        <script src="assets/server.js"></script>
    <script>
        let dummyEmail = "testhaptics@gmail.com"

        window.onGoogleLibraryLoad = ()=>{
            google.accounts.id.initialize({
                client_id: '350655354040-jcb0ecc1rq659on0hkj4e3o95g5vt794.apps.googleusercontent.com',
                cancel_on_tap_outside: false,
                prompt_parent_id:"root",
            });

            google.accounts.id.prompt((notification)=>{
                if(notification.isNotDisplayed()){
                    console.log(notification.getNotDisplayedReason());
                } else if (notification.isSkippedMoment()){
                    console.log(notification.getSkippedReason());
                } else if (notification.isDismissedMoment()){
                    console.log(notification.getDismissedReason());
                }else{

                }
            })
        }
        
        function handleCredentialResponse(response) {
            var decodedToken = jwt_decode(response.credential);
            console.log(decodedToken.name);
            console.log(decodedToken.email);
        }

        function displayForm() {
            let finalResult;
            const Form = JSONSchemaForm.default;
            const urls = ["assets/formschema.json", "assets/formuischema.json"];
            Promise.all(urls.map(url => fetch(url).then(e => e.json()))).then(data => {
                finalResult = data.flat();
                ReactDOM.render(React.createElement(Form, {schema: finalResult[0],uiSchema: finalResult[1],onSubmit: e => setFormData(e.formData)}), document.getElementById("app"));
            });
        }

        function setFormData(formData)
        {
            //Initial Fetch Test

            formData.email = userEmail
            console.log(formData.email)

            console.log(formData)

            fetch(lambdaServer+"/setExperiment",
                            {
                                method: "POST",
                               
                                body: JSON.stringify(formData),
                                headers: {'Content-Type': 'application/json;charset=utf-8'},
                            }
            ).then(response => response.json())
            .then(formData => {
                    console.log('Success:', formData);
            })
            .catch((error) => {
                console.error('Error:', error);
            });


            renderTable();
            closeModal(); //Fix: closeModal
        }

        function openModal() {
            var modal = document.getElementById("myModal");
            displayForm();
            modal.style.display = "block";
        }

        function closeModal() {
            renderTable();
            var modal = document.getElementById("myModal");            
            modal.style.display = "none";
        }
        
        function renderTable(){  
            fetch(lambdaServer+"/getByEmail",
                            {
                                method: "POST",
                               
                                body: JSON.stringify({email: dummyEmail}),
                                headers: {'Content-Type': 'application/json;charset=utf-8'},
                            }
            ).then(res => res.json()).then((data) => {
                console.log(data)
                var temp ="<table class='styled-table'><tr><th>ID</th><th>Description</th><th>Interaction Type</th><th>Max Score</th><th>Survey URL</th></tr>";
                for( var i=0;i<data.length;i++){
                    temp += "<tr>";
                        temp += "<td>";
                            temp += data[i].expid;
                        temp += "</td>";
                        temp += "<td>";
                            temp += data[i].experiment_description;
                        temp += "</td>";
                        temp += "<td>";
                            temp += data[i].interaction_type;
                        temp += "</td>";
                        temp += "<td>";
                            temp += data[i].experiment_maxscore;
                        temp += "</td>";
                        temp += "<td>";
                            temp += data[i].survey_url;
                        temp += "</td>";
                    temp += "</tr>";   
                }
                temp +="</table>"
                $('#root').html(temp)
            }).catch(err => {
                console.log(err);
                throw err}); 
        }

        function initialize()
        {
            //check if server variable is available
            if (lambdaServer == null)
            {
                alert("server url is not defined");
            }
            else
            {
                renderTable();
            }
        }

        </script>
    </head>

    <body onload="initialize();">
        
        <div id="g_id_onload"
         data-client_id="350655354040-jcb0ecc1rq659on0hkj4e3o95g5vt794.apps.googleusercontent.com"
         data-callback="handleCredentialResponse">
        </div>
        <div class="g_id_signin" data-type="standard"></div>

        <button class="button-24" style="float: right; margin: 40px;" onclick="openModal(); ">+</button>
        <div id="root" class="center" ></div>
        <div id="myModal" class="modal">
            <div class="modal-content">
              <span class="close" onclick="closeModal()">&times;</span>
              <div id="app"></div>
            </div>          
        </div>
    </body>
</html>
